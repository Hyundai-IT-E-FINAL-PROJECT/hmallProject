<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.team2.mapper.FundingMapper">
    <insert id="insertFunding">
        <selectKey keyProperty="fund_product_seq" resultType="int" order="BEFORE">
            select seq_fund_product.nextval from dual
        </selectKey>
        INSERT INTO TBL_FUND_PRODUCT(
                                    FUND_PRODUCT_SEQ,
                                    USER_SEQ,
                                    FUND_PRODUCT_START_DATE,
                                    FUND_PRODUCT_END_DATE,
                                    FUND_PRODUCT_GOAL_COST,
                                    FUND_PRODUCT_PR_COST,
                                    FUND_PRODUCT_TITLE,
                                    FUND_PRODUCT_CONTENT,
                                    FUND_PRODUCT_STATUS,
                                    FUND_PRODUCT_PARTICIPANTS,
                                    FUND_PRODUCT_MAIN_IMG,
                                    CREATED_AT,
                                    UPDATED_AT,
                                    FUND_PRODUCT_ESTIMATE_DATE
                                    )
                                    VALUES
                                    (
                                        #{fund_product_seq},
                                        #{no},
                                        sysdate,
                                        #{fund_product_end_date},
                                        #{fund_product_goal_cost},
                                        0,
                                        #{fund_product_title},
                                        #{fund_product_content},
                                        0,
                                        0,
                                        'aaa',
                                        sysdate,
                                        sysdate,
                                        #{fund_product_estimate_date}
                                    )
    </insert>

    <insert id="insertReward">
        INSERT INTO TBL_FUND_REWARD(
                                    FUND_REWARD_SEQ,
                                    FUND_PRODUCT_SEQ,
                                    CREATED_AT,
                                    UPDATED_AT,
                                    FUND_REWARD_TITLE,
                                    FUND_REWARD_CONTENT,
                                    FUND_REWARD_COUNT,
                                    FUND_REWARD_COST
                                    )
                                    VALUES
                                    (
                                     seq_fund_reward.nextval,
                                     #{fund_product_seq},
                                     sysdate,
                                     sysdate,
                                     #{fund_reward_title},
                                     #{fund_reward_content},
                                     #{fund_reward_count},
                                     #{fund_reward_cost}
                                    )
    </insert>

    <select id="getUserFund" resultType="org.team2.domain.FundVO">
        select *
        from tbl_fund_product
        where tbl_fund_product.user_seq=#{user_seq}
    </select>

    <select id="getAllFund" resultType="org.team2.domain.FundVO">
        select *
        from tbl_fund_product
    </select>

    <update id="updateFundStatus">
        update tbl_fund_product
        set FUND_PRODUCT_STATUS=1
        where tbl_fund_product.FUND_PRODUCT_SEQ=#{fund_product_seq}
    </update>

    <delete id="deleteUserFund" >
        delete from tbl_fund_product where fund_product_seq=#{fund_product_seq}
    </delete>
    <select id="readFundingProduct" resultType="map">
        SELECT FP.FUND_PRODUCT_SEQ,FP.FUND_PRODUCT_TITLE,
               FP.FUND_PRODUCT_PR_COST,FP.FUND_PRODUCT_GOAL_COST,
               FP.FUND_PRODUCT_MAIN_IMG,FP.FUND_PRODUCT_END_DATE,
               FP.FUND_PRODUCT_PARTICIPANTS, TU.USER_NAME
        FROM TBL_FUND_PRODUCT FP
                 INNER JOIN TBL_USER TU
                            ON FP.USER_SEQ = TU.USER_SEQ
    </select>

    <select id="readFundigProductDetail" resultType="map">
        SELECT FP.FUND_PRODUCT_SEQ, FP.FUND_PRODUCT_PR_COST, FP.FUND_PRODUCT_GOAL_COST,FP.FUND_PRODUCT_END_DATE,
               FR.FUND_REWARD_CONTENT, FR.FUND_REWARD_TITLE, FR.FUND_REWARD_COUNT, FR.FUND_REWARD_COST,
               FP.FUND_PRODUCT_ESTIMATE_DATE
        FROM TBL_FUND_PRODUCT FP
                 INNER JOIN TBL_FUND_REWARD FR
                            ON FP.FUND_PRODUCT_SEQ = FR.FUND_PRODUCT_SEQ
                            WHERE FP.FUND_PRODUCT_SEQ = #{fund_product_seq}
    </select>

    <insert id="insertReply">
        INSERT INTO TBL_FUND_REPLY(
                                    FUND_REPLY_SEQ,
                                    FUND_PRODUCT_SEQ,
                                    USER_SEQ,
                                    FUND_REPLY_CONTENT
                                   )
                                   VALUES
                                   (
                                    SEQ_FUND_REPLY.NEXTVAL,
                                    #{fund_product_seq},
                                    #{user_seq},
                                    #{fund_reply_content}
                                   )
    </insert>

    <select id="selectReply" resultType="map">
        SELECT URT.FUND_PRODUCT_SEQ, URT.USER_NAME, URT.FUND_REPLY_CONTENT, URT.FUND_REPLY_SEQ
        FROM
            (
                SELECT TU.USER_NAME, FR.FUND_REPLY_CONTENT, FR.FUND_PRODUCT_SEQ, TU.USER_SEQ, FR.FUND_REPLY_SEQ
                FROM TBL_FUND_REPLY FR
                    INNER JOIN TBL_USER TU
                        ON FR.USER_SEQ = FR.USER_SEQ
            ) URT
                INNER JOIN TBL_FUND_PRODUCT FP
                           ON FP.FUND_PRODUCT_SEQ = URT.FUND_PRODUCT_SEQ
        WHERE FP.FUND_PRODUCT_SEQ = #{fund_product_seq} AND URT.USER_SEQ = #{user_seq}
    </select>
</mapper>